name: Create rfsuite-lua-ethos ZIP on Push

on:
  push:
    branches:
      - 'master'
      - 'RF-*'

jobs:
  create-zip:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set build variables (commit-based version)
      run: |
        SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
        echo "GIT_VER=commit-${SHORT_SHA}" >> $GITHUB_ENV

    - name: Update version and config in main.lua
      run: |
        # Use GIT_VER set in previous step
        sed -i 's/\(config.version = {[^}]*suffix = \)"[^"]*"/\1"${{ env.GIT_VER }}"/' scripts/rfsuite/main.lua

        # Show updated file (for verification)
        grep 'config\.' scripts/rfsuite/main.lua

    - name: Create rotorflight-lua-ethos-suite-commit-<short_sha>.zip (entire scripts folder)
      run: |
        zip -q -r -9 "rotorflight-lua-ethos-suite-${{ env.GIT_VER }}.zip" scripts/rfsuite

    - name: Upload rotorflight-lua-ethos-suite-commit-<short_sha>.zip as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: rotorflight-lua-ethos-suite-${{ env.GIT_VER }}
        path: rotorflight-lua-ethos-suite-${{ env.GIT_VER }}.zip
        if-no-files-found: error
        
    # Package each soundpack into its own ZIP
    - name: Package soundpacks
      run: |
        SOUND_DIR="bin/sound-generator/soundpack"
        OUTPUT_DIR="soundpacks"
        mkdir -p "${OUTPUT_DIR}"
        for locale_dir in "${SOUND_DIR}"/*; do
          [ -d "${locale_dir}" ] || continue
          locale=$(basename "${locale_dir}")
          for pack_dir in "${locale_dir}"/*; do
            [ -d "${pack_dir}" ] || continue
            pack=$(basename "${pack_dir}")
            zip_name="rotorflight-lua-ethos-suite-${{ env.GIT_VER }}-soundpack-${locale}-${pack}.zip"
            (cd "${pack_dir}" && zip -r "../../${OUTPUT_DIR}/${zip_name}" .)
            echo "Created ${OUTPUT_DIR}/${zip_name}"
          done
        done
      shell: bash

    # Upload all generated soundpack ZIPs
    - name: Upload soundpack artifacts
      uses: actions/upload-artifact@v3
      with:
        name: soundpacks
        path: soundpacks/*.zip